package com.ua.kture.opentest.web;

import com.ua.kture.opentest.Util;
import com.ua.kture.opentest.domain.Student;
import com.ua.kture.opentest.domain.User;
import com.ua.kture.opentest.exceptions.UserException;
import com.ua.kture.opentest.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.ModelAndView;

import javax.servlet.http.HttpServletRequest;
import java.util.Map;

/**
 * Created by Mariia_Lukianets on 03.03.14.
 */
@Controller
public class LoginController { // TODO rename to LoginController

    @Autowired
    private UserService userService;

    @RequestMapping(value = "/login", method = RequestMethod.GET)
    public ModelAndView login(HttpServletRequest request) {
        ModelAndView modelAndView = new ModelAndView();
        User sessionUser = (User) request.getSession().getAttribute("user");
        if(sessionUser != null) {
            String viewName = Util.getViewName(sessionUser);
            modelAndView.setViewName(viewName);
        }
        modelAndView = new ModelAndView("login", "command", new User());

        return modelAndView;
    }

    @RequestMapping(value = "/login", method = RequestMethod.POST)
    public String login(@ModelAttribute("SpringWeb")User user,
                             ModelMap model, HttpServletRequest request) {


        try {
            // check if user exist in session
            User sessionUser = (User) request.getSession().getAttribute("user");
            if(sessionUser == null) {
                sessionUser = userService.login(user.getLogin(), user.getPassword());
                model.addAttribute("name", sessionUser.getLogin());
                //add user to session
                request.getSession().setAttribute("user", sessionUser);
            }

            return "redirect:/tests";
        }
        catch (UserException ex) {
            model.addAttribute("error", ex.getMessage());
            return "error";
        }
    }

    @RequestMapping(value = "/logout", method = RequestMethod.GET)
    public String logout(HttpServletRequest request) {
        ModelAndView modelAndView = new ModelAndView();
        String viewName = "error";
        User sessionUser = (User) request.getSession().getAttribute("user");
        if(sessionUser != null) {
            request.getSession().removeAttribute("user");
            viewName = "index";
        }
        modelAndView.setViewName(viewName);
        return "redirect:/login";
    }

}
